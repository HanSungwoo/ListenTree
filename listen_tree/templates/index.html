<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tree Chatbot</title>
    <style>
        /* 아이폰 앱 화면 크기 조정 */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f9f9f9;
            overflow: hidden;
        }
        .app-container {
            width: 375px;
            height: 667px;
            border: 1px solid #ccc;
            border-radius: 10px;
            position: relative;
            background-image: url('/static/background.png'); /* 배경 이미지 설정 부분 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
        }
        .setting-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 36px;
        }
        .progress-bar-container {
            width: 70%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 20px auto;
            position: relative;
            top: 0;
            left: 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #76c7c0;
            border-radius: 5px;
            transition: width 0.3s;
        }
        .icons {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
        }
        .icon {
            width: 30px;
            height: 36px;
            display: block;
            margin-bottom: 10px;
        }
        .tree {
            position: relative;
            pointer-events: none;
            width: 100%;
            margin-top: 80px;
            text-align: center;
        }
        .tree img {
            width: 50%;
        }
        .face-img {
            position: absolute;
            width: 25px;    /* 표정 이미지를 적절한 크기로 설정 */
            height: 25px;
            top: 52%;      /* 나무 얼굴 위치에 맞게 조정 (예시) */
            left: 52%;     /* 나무 얼굴 중앙에 맞춤 */
            transform: translate(-50%, -50%); /* 이미지 중심을 기준으로 위치 조정 */
            object-fit: contain; /* 이미지 비율 유지 */
        }
        .response {
            background-color: white;
            border-radius: 10px;
            padding: 10px;
            margin: 10px auto;
            display: inline-block;
            font-size: 18px;
        }
        .tree-response {
            background-color: #fff;
            border-radius: 10px;
            padding: 10px;
            font-size: 18px;
            margin: 10px auto;
            display: inline-block;
            color: green;
            text-align: center;
            height: 50px;
            overflow: scroll;
        }
        .fruit-img {
            position: absolute;
            width: 50px;
            height: 50px;
            object-fit: contain;
            cursor: pointer;
            display: block;
            padding: 0; /* 여백을 없애기 */
            margin: 0; /* 여백을 없애기 */
            pointer-events: auto;
            border: none; /* 필요 시 추가 */
            box-sizing: content-box; /* 이미지 크기가 실제 내용물만 반영 */
        }
        .fruit1 {
            width: 50px;
            height: 50px;
            top: 20%;
            left: 40%;
            transform: translate(-50%, -50%);
        }
        .fruit2 {
            width: 50px;
            height: 50px;
            top: 25%;
            left: 60%;
            transform: translate(-50%, -50%);
        }
        .fruit3 {
            width: 50px;
            height: 50px;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .user-response {
            background-color: #f1f1f1;
            border-radius: 10px;
            padding: 10px;
            font-size: 16px;
            color: blue;
            text-align: left;
            width: 80%;
            margin-bottom: 5px;
        }
        .typing-preview {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .input-wrapper {
            position: absolute;
            bottom: 0;                 /* 화면의 최하단에 고정 */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 10px;      /* 하단 여백을 줘서 요소들이 여유 있게 배치됨 */
            background-color: #f9f9f9; /* 입력 영역의 배경색을 추가해 구분되게 함 */
        }
        .input-container {
            position: relative;       /* input-wrapper 내에서 안정적으로 배치 */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .input-box {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .send-button {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        #fruit-info-modal {
            z-index: 1001;
        }
        .modal-overlay {
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: white;
            border: 2px solid #ccc;
            z-index: 1000;
            width: 300px;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            overflow: hidden;
        }

        .modal_for_fruit {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 350px;
            background-color: #EDEFD3; /* 새로운 배경 색상 적용 */
            border-radius: 15px; /* 테두리 라운딩 증가 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            padding: 20px;
            z-index: 10;
            overflow: hidden;
        }
        
        .modal_for_fruit-content {
            position: relative;
            background-color: transparent; /* 투명 배경으로 설정 */
            padding: 10px;
            text-align: center;
        }
        .modal_for_fruit p {
            font-size: 16px;
            color: #3D3D3D; /* 텍스트 색상 설정 */
            margin: 10px 0;
        }
        .modal_for_fruit-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .modal_for_fruit-buttons img {
            width: 50px;
            height: auto;
            cursor: pointer;
        }
        .modal_for_fruit-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal_for_fruit-close:hover {
            color: black;
        }

        .fruit-img-modal_for_fruit {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        .modal_for_fruit-img-button {
            width: 50px; /* 이미지 크기를 조정하세요 */
            height: 20px;
            cursor: pointer;
            margin: 0 20px; /* 버튼 사이 간격 */
        }
        .modal_for_fruit-img-button[aria-disabled="true"]{
            pointer-events: none;

            opacity: 0.5;
        }
        .modal_for_fruit-img-button[aria-disabled="false"] {
            pointer-events: auto; /* 클릭 활성화 */
            opacity: 1; /* 정상 버튼 스타일 */
        }
        .modal_for_fruit-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .modal_for_fruit-buttons button {
            padding: 5px 10px; /* 버튼 내부 여백 조정 */
            font-size: 14px; /* 버튼 글꼴 크기를 약간 줄임 */
            width: 40%; /* 버튼의 너비를 열매 크기에 비례하게 설정 */
            max-width: 80px; /* 최대 너비 제한 */
            height: 40px; /* 버튼의 높이를 고정하여 일관되게 설정 */
            border-radius: 5px; /* 버튼 모서리 라운드 */
            cursor: pointer;
        }
        .user-response {
            background-color: #f1f1f1;
            border-radius: 10px;
            padding: 10px;
            font-size: 16px;
            color: blue;
            text-align: left;
            width: 80%;
            margin-bottom: 5px;
        }
        .typing-preview {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .input-wrapper {
            position: absolute;
            bottom: 0;                 /* 화면의 최하단에 고정 */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 10px;      /* 하단 여백을 줘서 요소들이 여유 있게 배치됨 */
            background-color: #f9f9f9; /* 입력 영역의 배경색을 추가해 구분되게 함 */
        }
        .input-container {
            position: relative;       /* input-wrapper 내에서 안정적으로 배치 */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .input-box {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .send-button {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        .modal.show {
            display: block;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .modal-overlay.show {
            display: block;
        }
        .fruit-info-content {
            text-align: center;
            padding: 10px;
        }
        .fruit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3개의 열로 구성 */
            gap: 15px; /* 아이템 간격 */
            justify-content: center; /* 그리드 자체 수평 중앙 정렬 */
            justify-items: center; /* 그리드 항목 각각을 중앙 정렬 */
            align-items: center; /* 그리드 항목을 수직 중앙 정렬 */
            padding: 20px 0; /* 위아래 여백 추가 */
        }
        .pagination {
            margin-top: 10px;
            font-size: 16px;
        }
        .fruit-item {
            width: 90px;
            height: 90px;
            display: flex;
            align-items: center; /* 아이템 내부 이미지 수직 중앙 정렬 */
            justify-content: center; /* 아이템 내부 이미지 수평 중앙 정렬 */
            background-color: #e0e0e0;
            border-radius: 8px;
            position: relative;
        }
        .fruit-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* 이미지 비율 유지 */
        }
        .locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* 반투명 효과 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        #locked-message-modal {
            width: 300px;
            text-align: center;
        }
        .storage-container {
            width: 100%;
            height: 100%;
            text-align: center;
        }
        .storage-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 20px;
        }
        .storage-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: url('/static/storage/block.png');
            border-radius: 5px;
            margin-top: 3px;
            padding-bottom: 7px;
            text-align: center;
            width: 100%;
            background-size: 100% 100%;
        }
        .storage-date {
            font-size: 16px;
            font-weight: bold;
            margin-top: 2px;
            margin-bottom: 1px;
            text-align: center; /* 텍스트 중앙 정렬 */
            color: #333;
        }
        .storage-box{
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .fruit-container {
            display: flex;
            justify-content: space-between; /* 또는 flex-start */
            gap: 5px; /* 간격을 더 줄이거나 설정 가능 */
        }
        .fruit-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.0);
            border-radius: 8px;
            margin-bottom: 20px;
            width: 80px;
            height: 80px;
            margin: 3px;
        }
        .fruit-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: rgba(255, 255, 255, 0.0);
        }
        .pagination {
            margin-top: 10px;
            font-size: 16px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .pagination button {
            padding: 8px 12px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .pagination span {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="setting-icon">
            <img src="/static/icons/settings.png" alt="Settings" class="icon">
        </div>
        <div class="icons">
            <img src="/static/icons/book.png" alt="도감" class="icon">
            <img src="/static/icons/storage.png" alt="보관함" class="icon">
        </div>
        <!-- 새로운 수확 완료 모달 -->
        <div id="completion_modal_for_fruit" class="modal_for_fruit">
            <div class="modal_for_fruit-content">
                <p id="completionMessage">축하합니다! 나무가 이야기를 듣고 잘 자라서 열매를 맺고 수확을 마쳤습니다. 이제 보관함에서 열매를 확인해 보세요.</p>
            </div>
        </div>
        <div id="fruit_modal_for_fruit" class="modal_for_fruit">
            <div class="modal_for_fruit-content">
                <span class="modal_for_fruit-close" id="close_modal_for_fruit">&times;</span>
                <img src="" alt="Fruit Image" class="fruit-img-modal_for_fruit" id="modal_for_fruit_FruitImg">
                <p id="modal_for_fruit_FruitSummary">아직 열매가 맺히는 중이에요!</p>
                <div class="modal_for_fruit-buttons">
                    <img src="/static/icons/delete_button.png" id="deleteFruit" alt="삭제 버튼" class="modal_for_fruit-img-button" aria-disabled="false">
                    <img src="/static/icons/save_button.png" id="saveFruit" alt="저장 버튼" class="modal_for_fruit-img-button" aria-disabled="false">
                </div>                
            </div>
        </div>
        <div class="tree">
            <img src="/static/tree/seed.png" alt="Tree" id = "tree">
            <img src="" alt="FaceImg" class="face-img" id="face">
            <img src="/static/fruit/fruit_0.png" alt="Fruit1" class="fruit-img fruit1" id="fruit1" style="display: none;">
            <img src="/static/fruit/fruit_0.png" alt="Fruit2" class="fruit-img fruit2" id="fruit2" style="display: none;">
            <img src="/static/fruit_bad/b_fruit_0.png" alt="Fruit3" class="fruit-img fruit3" id="fruit3" style="display: none;">

            <div class="tree-response" id="tree-response">당신의 이야기를 듣고싶어요!</div>
        </div>
        <div id="seed_modal_for_fruit" class="modal_for_fruit">
            <div class="modal_for_fruit-content">
                <p id="seedMessage">새로운 씨앗이 심어졌어요! 이야기를 들려주세요!</p>
            </div>
        </div>
        <div class="input-wrapper">
            <div class="user-response" id="user-response"></div> <!-- 사용자 입력 표시 영역 -->
            <div class="typing-preview" id="typing-preview"></div> <!-- 타이핑 미리보기 영역 -->
            <div class="input-container">
                <input type="text" id="user-input" class="input-box" placeholder="여기에 메시지를 입력하세요...">
                <button class="send-button" onclick="sendMessage()">Enter</button>
            </div>

            <!-- 도감 모달 -->
            <div id="gallery-modal" class="modal">
                <span id="close-gallery-modal" style="cursor: pointer; font-size: 24px; position: absolute; top: 10px; right: 10px;">✖</span>
                <div class="gallery-container">
                    <h2>도감</h2>
                    <div class="fruit-grid" id="fruit-grid">
                        <!-- 과일 아이템이 여기 렌더링됩니다. -->
                    </div>
                    <div class="pagination">
                        <button id="prev-page" style="margin-right: 10px;">이전</button>
                        <span id="page-number">1/3</span>
                        <button id="next-page" style="margin-left: 10px;">다음</button>
                    </div>
                </div>
            </div>

            <!-- 모달 오버레이 -->
            <div id="modal-overlay" class="modal-overlay"></div>

            <!-- 과일 상세 정보 모달 -->
            <div id="fruit-info-modal" class="modal">
                <span id="close-fruit-info-modal" style="cursor: pointer; font-size: 24px; position: absolute; top: 10px; right: 10px;">✖</span>
                <div class="fruit-info-content">
                    <img id="fruit-info-image" src="" alt="Fruit Image" style="width: 100px; height: 100px; margin: 10px auto;">
                    <p id="fruit-info-description"></p> <!-- 요약문 표시 요소 -->
                </div>
            </div>

            <!-- 잠금 메시지 모달 -->
            <div id="locked-message-modal" class="modal">
                <div class="locked-message-content">
                    <p>아직 잠금되어 있는 과일입니다</p>
                </div>
            </div>

            <div id="storage-modal" class="modal">
                <span id="close-storage-modal" style="cursor: pointer; font-size: 24px; position: absolute; top: 10px; right: 10px;">✖</span>
                <div class="storage-container">
                    <h2>보관함</h2>
                    <div class="storage-grid" id="storage-grid">
                        <!-- 과일 상자가 여기 렌더링됩니다. -->
                    </div>
                    <div class="pagination">
                        <button id="prev-storage-page" style="margin-right: 10px;">이전</button>
                        <span id="storage-page-number">1/1</span>
                        <button id="next-storage-page" style="margin-left: 10px;">다음</button>
                    </div>
                </div>
            </div>
            
            <!-- 과일 요약 모달 -->
            <div id="fruit-summary-modal" class="modal">
                <span id="close-fruit-summary-modal" style="cursor: pointer; font-size: 24px; position: absolute; top: 10px; right: 10px;">✖</span>
                <div class="fruit-summary-content">
                    <img id="fruit-summary-image" src="" alt="Fruit Image" style="width: 100px; height: 100px; margin: 10px auto;">
                    <p id="fruit-summary-description"></p>
                </div>
            </div>
            <div id="modal-overlay" class="modal-overlay"></div>
        </div>
    </div>
</body>

<script>
        let typingTimer;
        const doneTypingInterval = 2000;
        let collectedTexts = [];

        let fruits = []; // JSON 파일에서 로드된 과일 데이터를 저장할 변수
        let fruitsInStorage = []; // JSON 파일에서 로드된 보관함 데이터를 저장할 변수

        let currentPage = 1;
        const fruitsPerPage = 9;
        let totalPages = 0;

        let currentStoragePage = 1;
        const storageItemsPerPage = 3;
        let totalStoragePages = 0;
        
        async function loadFruits() {
            try {
                const response = await fetch('/fruits');
                fruits = await response.json();
                totalPages = Math.ceil(fruits.length / fruitsPerPage);
                renderFruits(); // 데이터 로드 후 도감 렌더링
            } catch (error) {
                console.error("Error loading fruits:", error);
            }
        }

        // 보관함 데이터를 가져오기
        async function loadFruitsStorage() {
            try {
                const response = await fetch('/fruits_storage');
                fruitsInStorage = await response.json();
                totalStoragePages = Math.ceil(fruitsInStorage.length / storageItemsPerPage);
                renderStorageItems(); // 데이터 로드 후 보관함 렌더링
            } catch (error) {
                console.error("Error loading storage items:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const openGalleryModalButton = document.querySelector(".icon[alt='도감']");
            const closeGalleryModalButton = document.getElementById("close-gallery-modal");

            const openStorageModalButton = document.querySelector(".icon[alt='보관함']");
            const closeStorageModalButton = document.getElementById("close-storage-modal");

            const overlay = document.getElementById("modal-overlay");
            const closeFruitInfoModalButton = document.getElementById("close-fruit-info-modal");
            const closeFruitSummaryModalButton = document.getElementById("close-fruit-summary-modal");

            // 도감 모달 열기/닫기
            openGalleryModalButton?.addEventListener("click", openGalleryModal);
            closeGalleryModalButton?.addEventListener("click", closeModal);

            // 보관함 모달 열기/닫기
            openStorageModalButton?.addEventListener("click", openStorageModal);
            closeStorageModalButton?.addEventListener("click", closeStorageModal);

            // 과일 설명 모달 닫기
            closeFruitInfoModalButton?.addEventListener("click", closeFruitInfoModal);

            // 과일 요약 모달 닫기
            closeFruitSummaryModalButton?.addEventListener("click", closeFruitSummaryModal);

            // 오버레이 클릭 시 열려 있는 모든 모달 닫기
            overlay?.addEventListener("click", () => {
                closeModal();
                closeStorageModal();
                closeFruitInfoModal();
                closeFruitSummaryModal();
            });

            document.getElementById("next-page")?.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderFruits();
                }
            });

            document.getElementById("prev-page")?.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderFruits();
                }
            });

            document.getElementById("next-storage-page")?.addEventListener("click", () => {
                if (currentStoragePage < totalStoragePages) {
                    currentStoragePage++;
                    renderStorageItems();
                }
            });

            document.getElementById("prev-storage-page")?.addEventListener("click", () => {
                if (currentStoragePage > 1) {
                    currentStoragePage--;
                    renderStorageItems();
                }
            });

            loadFruits();
            loadFruitsStorage(); // JSONL 데이터 로드
        });

        function openGalleryModal() {
            document.getElementById("gallery-modal").classList.add("show");
            document.getElementById("modal-overlay").classList.add("show");
        }

        function closeModal() {
            document.getElementById("fruit-info-modal").classList.remove("show");
            document.getElementById("modal-overlay").classList.remove("show");
            document.getElementById("gallery-modal").classList.remove("show");
            document.getElementById("modal-overlay").classList.remove("show");
        }

        function openStorageModal() {
            document.getElementById("storage-modal").classList.add("show");
            document.getElementById("modal-overlay").classList.add("show");
        }

        function closeStorageModal() {
            document.getElementById("fruit-summary-modal").classList.remove("show");
            document.getElementById("modal-overlay").classList.remove("show");
            document.getElementById("storage-modal").classList.remove("show");
            document.getElementById("modal-overlay").classList.remove("show");
        }

        function openFruitInfoModal(fruit) {
            document.getElementById("fruit-info-image").src = fruit.image;
            document.getElementById("fruit-info-description").textContent = fruit.description;
            document.getElementById("fruit-info-modal").classList.add("show");
            document.getElementById("modal-overlay").classList.add("show");
        }

        function closeFruitInfoModal() {
            document.getElementById("fruit-info-modal").classList.remove("show");
            document.getElementById("modal-overlay").classList.remove("show");
        }

        function openFruitSummaryModal(fruit) {
            document.getElementById("fruit-summary-image").src = fruit.image;
            document.getElementById("fruit-summary-description").textContent = fruit.summary;
            document.getElementById("fruit-summary-modal").classList.add("show");
            document.getElementById("modal-overlay").classList.add("show");
        }

        function closeFruitSummaryModal() {
            document.getElementById("fruit-summary-modal").classList.remove("show");
            document.getElementById("modal-overlay").classList.remove("show");
        }

        function showLockedMessage() {
            const lockedMessageModal = document.getElementById("locked-message-modal");
            lockedMessageModal.classList.add("show");
            setTimeout(() => {
                lockedMessageModal.classList.remove("show");
            }, 1000);
        }

        function renderFruits() {
        const fruitGrid = document.getElementById("fruit-grid");
        fruitGrid.innerHTML = "";
        const start = (currentPage - 1) * fruitsPerPage;
        const end = start + fruitsPerPage;
        const currentFruits = fruits.slice(start, end);

        currentFruits.forEach(fruit => {
            const fruitItem = document.createElement("div");
            fruitItem.className = "fruit-item";

            if (fruit.unlocked) {
                fruitItem.innerHTML = `<img src="${fruit.image}" alt="${fruit.name}">`;
                fruitItem.addEventListener("click", () => openFruitInfoModal(fruit));
            } else {
                fruitItem.innerHTML = `
                    <div class="locked-overlay">
                        <img src="/static/img_for_gallery/locked.png" alt="Locked">
                    </div>
                `;
                fruitItem.addEventListener("click", showLockedMessage);
            }

            fruitGrid.appendChild(fruitItem);
        });

        document.getElementById("page-number").textContent = `${currentPage}/${totalPages}`;
    }

    function renderStorageItems() {
        const storageGrid = document.getElementById("storage-grid");
        storageGrid.innerHTML = "";

        const groupedByDate = {};
        fruitsInStorage.forEach(fruit => {
            if (!groupedByDate[fruit.date]) {
                groupedByDate[fruit.date] = [];
            }
            groupedByDate[fruit.date].push(fruit);
        });

        const groupedDates = Object.keys(groupedByDate).map(date => ({
            date,
            fruits: groupedByDate[date]
        }));

        const startIndex = (currentStoragePage - 1) * storageItemsPerPage;
        const endIndex = startIndex + storageItemsPerPage;
        const currentGroups = groupedDates.slice(startIndex, endIndex);

        currentGroups.forEach(group => {
            const storageBox = document.createElement("div");
            storageBox.className = "storage-box";

            const dateElement = document.createElement("div");
            dateElement.className = "storage-date";
            dateElement.textContent = group.date;
            storageBox.appendChild(dateElement);

            const fruitContainer = document.createElement("div");
            fruitContainer.className = "fruit-container";
            fruitContainer.style.display = "flex";
            fruitContainer.style.justifyContent = group.fruits.length === 2 ? "flex-start" : "space-between";

            group.fruits.slice(0, 3).forEach(fruit => {
                const fruitItem = document.createElement("div");
                fruitItem.className = "fruit-item";

                const fruitImage = document.createElement("img");
                fruitImage.src = fruit.image;
                fruitImage.alt = fruit.name;
                fruitImage.addEventListener("click", () => openFruitSummaryModal(fruit));

                fruitItem.appendChild(fruitImage);
                fruitContainer.appendChild(fruitItem);
            });

            for (let i = group.fruits.length; i < 3; i++) {
                const emptyItem = document.createElement("div");
                emptyItem.className = "fruit-item";
                fruitContainer.appendChild(emptyItem);
            }

            storageBox.appendChild(fruitContainer);
            storageGrid.appendChild(storageBox);
        });

        document.getElementById("storage-page-number").textContent = `${currentStoragePage}/${Math.ceil(groupedDates.length / storageItemsPerPage)}`;
    }

        

        // 기존 기능 관련 코드 (타이핑 감지 및 프로그레스 바 업데이트)
        document.addEventListener("DOMContentLoaded", function() {
            const userInput = document.getElementById("user-input");
            const typingPreview = document.getElementById("typing-preview");
            const treeResponse = document.getElementById("tree-response"); // 나무 응답 영역
            const userResponse = document.getElementById("user-response"); // 사용자 입력 영역
            const faceImg = document.getElementById('face');

            const fruit_modal_for_fruit = document.getElementById("fruit_modal_for_fruit");
            const close_modal_for_fruit = document.getElementById("close_modal_for_fruit");
            const modal_for_fruit_FruitImg = document.getElementById("modal_for_fruit_FruitImg");
            const modal_for_fruit_FruitSummary = document.getElementById("modal_for_fruit_FruitSummary");
            const deleteFruit = document.getElementById("deleteFruit");
            const saveFruit = document.getElementById("saveFruit");

            let currentFruitElement = null;

            // 예시: 열매 이미지에 클릭 이벤트 추가
            document.getElementById("fruit1").onclick = function() {
                showFruit_modal_for_fruit(1, "첫 번째 열매 요약 내용입니다.");
            };
            document.getElementById("fruit2").onclick = function() {
                showFruit_modal_for_fruit(2, "두 번째 열매 요약 내용입니다.");
            };
            document.getElementById("fruit3").onclick = function() {
                showFruit_modal_for_fruit(3, "세 번째 열매 요약 내용입니다.");
            };

            // 열매를 클릭했을 때 모달을 표시하는 함수
            function showFruit_modal_for_fruit(fruitId, summary) {
                const fruitElement = document.getElementById(`fruit${fruitId}`);

                if (fruitElement) {
                    modal_for_fruit_FruitImg.src = fruitElement.src;
                } else {
                    modal_for_fruit_FruitImg.src = `/static/fruit/fruit_0.png`;
                }

                modal_for_fruit_FruitSummary.innerText = summary;
                fruit_modal_for_fruit.style.display = "block";
                currentFruitElement = fruitElement;
            }
            // 모달 외부를 클릭하여 닫기
            window.onclick = function(event) {
                if (event.target == fruit_modal_for_fruit) {
                    fruit_modal_for_fruit.style.display = "none";
                }
            }
            faceImg.src = "/static/face/face_neutral.png";

            // 입력 필드에서 타이핑 중 발생하는 이벤트
            userInput.addEventListener("keyup", function(event) {
                clearTimeout(typingTimer);

                // 새로운 입력이 시작될 때 user-response 내용을 초기화
                if (collectedTexts.length === 0) {
                    userResponse.innerText = ""; // 사용자 입력 표시 영역 초기화
                }

                // 현재 입력값을 실시간으로 타이핑 미리보기 텍스트에 표시
                typingPreview.innerText = userInput.value;

                // 사용자가 Enter 키를 눌렀을 때
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    let text = userInput.value.trim();
                    if (text.length > 0) {
                        collectedTexts.push(text);
                        userResponse.innerText += `${text}\n`; // 기존 내용에 새로운 입력을 개행하여 추가
                        userInput.value = '';  // 입력 필드 초기화
                        typingPreview.innerText = '';  // 타이핑 미리보기 초기화
                    }
                }

                // 타이핑을 멈추었을 때 3초간 대기 후 서버로 전송
                typingTimer = setTimeout(doneTyping, doneTypingInterval);
            });

            // 사용자가 타이핑을 멈추었을 때 서버로 요청을 보냄
            function doneTyping() {
                if (collectedTexts.length > 0) {
                    let combinedText = collectedTexts.join(" ");
                    sendMessage(combinedText);
                    collectedTexts = [];  // 수집한 텍스트 배열 초기화
                }
                typingPreview.innerText = '';  // 타이핑 미리보기 초기화
            }
            let currentPromptCount = 0; // 현재 프롬프트 수
            const stageThresholds = [10, 30, 60, 100, 150]; // 각 단계별 프롬프트 목표
            const progressBar = document.getElementById("progress-bar");

            function updateProgressBar() {
                currentPromptCount += 1;

                // 현재 단계를 결정
                let stageIndex = stageThresholds.findIndex(threshold => currentPromptCount < threshold);
                if (stageIndex === -1) stageIndex = stageThresholds.length - 1;

                // 현재 단계의 시작 프롬프트 수와 목표 프롬프트 수
                const prevThreshold = stageIndex > 0 ? stageThresholds[stageIndex - 1] : 0;
                const currentThreshold = stageThresholds[stageIndex];

                // 현재 단계에서의 진행률 계산
                const progressPercentage = ((currentPromptCount - prevThreshold) / (currentThreshold - prevThreshold)) * 100;

                // 프로그레스 바 너비 업데이트
                progressBar.style.width = `${progressPercentage}%`;
            }

            async function sendMessage(message) {
            // 사용자 입력을 서버로 보내기
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            treeResponse.innerText = `${data.response}`;

            // 나무 성장 상태에 따른 이미지 업데이트
            const treeStage = data.tree_stage;
            const treeImg = document.querySelector('.tree img');
            if (treeStage === "end") {
                treeImg.src = `/static/tree/fruit_tree.png`;
            } else {
                treeImg.src = `/static/tree/${treeStage}.png`;
            }

            // tree_stage가 "end"일 때만 열매 표시
            const fruit1 = document.getElementById('fruit1');
            const fruit2 = document.getElementById('fruit2');
            const fruit3 = document.getElementById('fruit3');

            const saveButton = document.getElementById("saveFruit");
            const deleteButton = document.getElementById("deleteFruit");
            const closeButton = document.getElementById("close_modal_for_fruit");

            if (treeStage === "fruit_tree") {
                saveButton.setAttribute("aria-disabled", "true");
                deleteButton.setAttribute("aria-disabled", "true");
            }
            else if (treeStage === "end") {
                saveButton.setAttribute("aria-disabled", "false");
                deleteButton.setAttribute("aria-disabled", "false");

            }else {
                fruit1.style.display = "none";
                fruit2.style.display = "none";
                fruit3.style.display = "none";
                aveButton.setAttribute("aria-disabled", "false");
                deleteButton.setAttribute("aria-disabled", "false");
            }
            // tree_stage가 "end"인 경우에만 열매 업데이트
            if (treeStage === "end") {
                data.fruits.forEach((fruit, index) => {
                    document.getElementById(`fruit${index + 1}`).onclick = function () {
                        showFruit_modal_for_fruit(fruit.id, fruit.summary);
                    };
                });
                loadFruitImages();
            } else {
                treeImg.src = `/static/tree/${treeStage}.png`;
            }
            function showCompletion_modal_for_fruit(message, callback) {
                const completion_modal_for_fruit = document.getElementById("completion_modal_for_fruit");
                const completionMessage = document.getElementById("completionMessage");

                // 메시지를 설정하고 모달 표시
                completionMessage.innerText = message;
                completion_modal_for_fruit.style.display = "block";

                // 클릭 시 모달을 닫고 콜백 실행
                completion_modal_for_fruit.onclick = function () {
                    completion_modal_for_fruit.style.display = "none"; // 모달 숨기기
                    if (callback) callback(); // 콜백 함수 실행
                };
            }
            function showSeed_modal_for_fruit(message, callback) {
                const seed_modal_for_fruit = document.getElementById("seed_modal_for_fruit");
                const seedMessage = document.getElementById("seedMessage");

                // 메시지를 설정하고 모달 표시
                seedMessage.innerText = message;
                seed_modal_for_fruit.style.display = "block";

                // 클릭 시 모달을 닫고 콜백 실행
                seed_modal_for_fruit.onclick = function () {
                    seed_modal_for_fruit.style.display = "none"; // 모달 숨기기
                    if (callback) callback(); // 콜백 함수 실행
                };
            }

            function handleAllFruitsCollected() {
                showCompletion_modal_for_fruit(
                    "축하합니다! 나무가 이야기를 듣고 잘 자라서 열매를 맺고 수확을 마쳤습니다. 이제 보관함에서 열매를 확인해 보세요.",
                    function () {
                        // "축하합니다~" 모달을 닫은 후 화면을 비움
                        resetTreeToEmptyStage();
                    }
                );
            }

            // 나무와 대화 내용을 초기화 (배경만 남김)
            function resetTreeToEmptyStage() {
                const appContainer = document.querySelector(".app-container");
                // 나무와 텍스트, 표정을 숨김
                // 빈 화면 클릭 이벤트 등록
                appContainer.onclick = function () {
                    appContainer.onclick = null; // 클릭 이벤트 제거
                    showSeed_modal_for_fruit("새로운 씨앗이 심어졌어요! 이야기를 들려주세요!", resetTreeToSeedStage);
                };
            }

            let harvestedFruitsCount = 0; // 수확된 열매 수
            const totalFruits = 3; // 전체 열매 개수

            // 나무를 seed 상태로 초기화
            function resetTreeToSeedStage() {
                const treeResponse = document.getElementById("tree-response");

                // 나무, 표정, 텍스트를 초기 상태로 설정
                treeImg.src = '/static/tree/seed.png';

                progressBar.style.width = "0%";
                currentPromptCount = 0;

                treeResponse.innerText = "당신의 이야기를 듣고싶어요!";

                // 서버에 초기화 요청
                fetch('/reset_tree', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                });
            }

            // 열매 삭제
            deleteFruit.onclick = function() {
                if (currentFruitElement && currentFruitElement.style.display !== "none") {
                    currentFruitElement.style.display = "none";
                    fruit_modal_for_fruit.style.display = "none";

                    if (harvestedFruitsCount + 1 === totalFruits) {
                        //showHarvestSequence(); // 마지막 열매를 수확하면 진행
                        handleAllFruitsCollected();
                    } else {
                        harvestedFruitsCount++; // 수확된 열매 수 증가
                    }
                }
            }

            // 열매 저장
            saveFruit.onclick = function() {
                if (currentFruitElement && currentFruitElement.style.display !== "none") {
                    currentFruitElement.style.display = "none";
                    fruit_modal_for_fruit.style.display = "none";

                    if (harvestedFruitsCount + 1 === totalFruits) {
                        //showHarvestSequence(); // 마지막 열매를 수확하면 진행
                        handleAllFruitsCollected();
                    } else {
                        harvestedFruitsCount++; // 수확된 열매 수 증가
                    }
                }
            }
            closeButton.addEventListener("click", function () {
                const fruitModal = document.getElementById("fruit_modal_for_fruit");
                fruitModal.style.display = "none"; // 모달 닫기
            });
            
            // 감정 분석 요청 추가 및 표정 업데이트
            const emotionResponse = await fetch('/analyze_emotion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });
            const emotionData = await emotionResponse.json();
            updateFaceImage(emotionData.emotion);
            updateProgressBar();
            }
            async function loadFruitImages() {
                try {
                    const response = await fetch('/generate_fruit_images', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    const fruits = await response.json();
                    if (fruits.length > 0) {
                        fruit1.src = fruits[0]?.image_path || "";
                        fruit2.src = fruits[1]?.image_path || "";
                        fruit3.src = fruits[2]?.image_path || "";

                        fruit1.style.display = "block";
                        fruit2.style.display = "block";
                        fruit3.style.display = "block";
                    }
                } catch (error) {
                    console.error("Error loading fruit images:", error);
                }
            }
            // 표정 업데이트 함수 분리
            function updateFaceImage(emotion) {
                // 감정에 맞는 표정으로 변경
                if (emotion) {
                    faceImg.src = `/static/face/face_${emotion}.png`;
                } else {
                    faceImg.src = "/static/face/face_neutral.png"; // 감정이 없을 때 기본 표정
                }

                // 일정 시간 후 기본 표정으로 되돌리기
                setTimeout(() => {
                    faceImg.src = "/static/face/face_neutral.png";
                }, 60000); // 60초 후 기본 표정으로 돌아감
            }

        });
    </script>
</body>
</html>

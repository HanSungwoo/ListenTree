<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tree Growth Chatbot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Welcome to the Tree Growth Chatbot</h1>
    <div>
        <p>Current Tree Stage: <span id="tree-stage">Seed</span></p>
        <div id="tree-image">
            <!-- 여기에 나무 이미지를 나무 단계에 따라 업데이트하여 보여줄 수 있습니다 -->
        </div>
        <div id="fruits">
            <h3>Your Fruits</h3>
            <ul id="fruit-list"></ul>
        </div>
    </div>

    <form id="chat-form">
        <input type="text" id="user-input" name="message" placeholder="Say something to the chatbot" required>
        <button type="submit">Send</button>
    </form>

    <div id="response">
        <h3>Chatbot Response:</h3>
        <p id="chatbot-response"></p>
    </div>

    <script>
        let typingTimer;  // 타이머 변수
        const doneTypingInterval = 2000;  // 사용자가 타이핑을 멈춘 후 기다리는 시간 (2초)

        $(document).ready(function() {
            // 타이핑 중에 타이머를 초기화
            $('#user-input').on('keyup', function() {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(doneTyping, doneTypingInterval);
            });

            // 폼 서밋을 통한 서버 요청 처리
            $('#chat-form').on('submit', function(event) {
                event.preventDefault(); // 폼 기본 동작 막기
                sendMessage();
            });

            // 사용자가 타이핑을 멈추었을 때 서버로 요청을 보냄
            function doneTyping() {
                sendMessage();
            }

            // 서버에 메시지 전송
            function sendMessage() {
                let userMessage = $('#user-input').val();
                if (userMessage.trim().length > 0) {
                    $.ajax({
                        url: '/chat',
                        type: 'POST',
                        data: { message: userMessage },
                        success: function(data) {
                            $('#chatbot-response').text(data.response);
                            $('#tree-stage').text(data.tree_stage);
                            $('#user-input').val('');  // 입력 필드를 초기화

                            // 열매 리스트 업데이트
                            let fruitList = $('#fruit-list');
                            fruitList.empty();
                            data.fruits.forEach(fruit => {
                                fruitList.append(`<li><button onclick="showSummary(${fruit.id})">Fruit ${fruit.id}</button></li>`);
                            });
                        }
                    });
                }
            }
        });

        function showSummary(fruitId) {
            $.get(`/fruit/${fruitId}`, function(data) {
                alert(`Summary: ${data.summary}`);
            });
        }
    </script>
</body>
</html>
